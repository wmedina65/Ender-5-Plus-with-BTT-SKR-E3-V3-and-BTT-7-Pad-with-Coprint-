# This file contains pin mappings for the Creality Ender 5 Plus.
# My Ender 5 Plus uses BTT Skr Mini E3 V3, with a BTT Pad 7 as the Pi alternative
# To use this config, the firmware should be compiled for the Stm32G0B1.

# See the example.cfg file for a description of available parameters.

[virtual_sdcard]
path: ~/printer_data/gcodes

#[virtual_sdcard]
#path: /home/biqu/printer_data/gcodes

[pause_resume]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_3B005A0005504E5238363120-if00
  
[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC0
position_endstop: 0
position_max: 300
homing_speed: 100

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.580
stealthchop_threshold: 999999

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC1
position_endstop: 300
position_max: 300
homing_speed: 100

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.580
stealthchop_threshold: 999999

[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0.0   # not used with a probe, keep commented
position_min: -5
position_max: 400

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.580
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
#PID parameters: pid_Kp=59.196 pid_Ki=0.678 pid_Kd=1291.942
control: pid
pid_Kp: 59.196
pid_Ki: 0.678
pid_Kd: 1291.942
min_temp: 0
max_temp: 130

# [fan]
# pin: PH6

[probe]
pin: cp_Head:PA3
x_offset: 0
y_offset: 25
z_offset: 4.230
speed: 5
lift_speed: 10.0
samples: 2
samples_result: median
sample_retract_dist: 0.5
samples_tolerance: 0.1
samples_tolerance_retries: 10

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 2000 # 20x print speed recommended
max_z_velocity: 5
max_z_accel: 100

[bed_mesh]
speed: 120
horizontal_move_z: 6
mesh_min: 40, 25
mesh_max: 300, 325
probe_count: 9,9
algorithm: bicubic
fade_start: 1.0
fade_end: 10.0

#split_delta_z: 0.025          ; good for delta, optional for cartesian but safe
fade_start: 1
fade_end: 10
fade_target: 0
move_check_distance: 5

[bed_screws]
screw1: 50, 50
screw2: 300, 50
screw3: 300, 300
screw4: 50, 300

# ==========================
# 1️⃣ AUTO MESH (Safe one-click)
# ==========================
[gcode_macro AUTO_MESH]
description: One-click auto bed mesh (safe)
gcode:
    {% if "default" not in printer.bed_mesh.profiles %}
        RESPOND PREFIX="BED_MESH" MSG="No mesh profile found. Probing bed..."
        G28
        BED_MESH_CLEAR
        BED_MESH_CALIBRATE
        SAVE_CONFIG
        RESPOND PREFIX="BED_MESH" MSG="Mesh probing complete and saved as 'default'."
    {% else %}
        RESPOND PREFIX="BED_MESH" MSG="Mesh profile 'default' exists. Loading..."
        BED_MESH_PROFILE LOAD=default
    {% endif %}
    BED_MESH_PROFILE PRINT
    RESPOND PREFIX="BED_MESH" MSG="Bed mesh active."

# ==========================
# 2️⃣ ULTRA-FAST PRINT START
# ==========================
[gcode_macro PRINT_START]
description: Start print safely, fast, slicer-aware temps, optional prime
gcode:
    {% set BED = params.BED_TEMP|default(60)|float %}
    {% set HOTEND = params.EXTRUDER_TEMP|default(200)|float %}
    {% set PRIME = params.PRIME|default(True) %}

    G90
    M83

    ; ---------------------------
    ; 1️⃣ Start heating (non-blocking)
    ; ---------------------------
    M140 S{BED}
    M104 S{HOTEND}

    ; ---------------------------
    ; 2️⃣ Home printer while heating
    ; ---------------------------
    G28

    ; ---------------------------
    ; 3️⃣ Load / auto-probe bed mesh
    ; ---------------------------
    AUTO_MESH

    ; ---------------------------
    ; 4️⃣ Wait for temps (blocking)
    ; ---------------------------
    M190 S{BED}
    M109 S{HOTEND}

    ; ---------------------------
    ; 5️⃣ Optional prime line
    ; ---------------------------
    {% if PRIME %}
        G92 E0
        G1 Z15 F900
        G1 X10 Y5 F6000
        G1 Z0.3 F900
        G1 Y280 E25 F1200
        G1 X12 F6000
        G1 Y5 E30 F1200
        G92 E0
        G1 Z5 F900
    {% else %}
        G1 Z5 F900
    {% endif %}

    ; ---------------------------
    ; 6️⃣ Move to center start
    ; ---------------------------
    G1 X150 Y150 F6000

# ==========================
# 3️⃣ PRINT END
# ==========================
[gcode_macro PRINT_END]
description: End print safely
gcode:
    G92 E0
    G1 E-2 F2400
    G1 Z10 F900
    G1 X0 Y350 F6000
    M104 S0
    M140 S0
    M84

# ==========================
# 4️⃣ REMESH BED (One-click UI)
# ==========================
[gcode_macro REMESH_BED_UI]
description: One-click safe bed re-mesh for Fluidd/Mainsail
gcode:
    RESPOND PREFIX="BED_MESH_UI" MSG="Starting safe bed re-mesh..."

    ; 1️⃣ Home printer if not homed
    {% if printer.homing.has_homed == false %}
        RESPOND PREFIX="BED_MESH_UI" MSG="Homing printer..."
        G28
    {% endif %}

    ; 2️⃣ Clear existing mesh
    BED_MESH_CLEAR

    ; 3️⃣ Calibrate / probe bed
    RESPOND PREFIX="BED_MESH_UI" MSG="Probing bed mesh now..."
    BED_MESH_CALIBRATE

    ; 4️⃣ Save mesh as default
    SAVE_CONFIG
    RESPOND PREFIX="BED_MESH_UI" MSG="Mesh saved as 'default'."

    ; 5️⃣ Load mesh for printing
    BED_MESH_PROFILE LOAD=default
    BED_MESH_PROFILE PRINT
    RESPOND PREFIX="BED_MESH_UI" MSG="Bed mesh active and ready for printing."

# ==========================
# 5️⃣ LOAD BED MESH (Manual)
# ==========================
[gcode_macro LOAD_BED_MESH]
description: Load saved bed mesh manually
gcode:
    BED_MESH_PROFILE LOAD=default
    BED_MESH_PROFILE PRINT
    RESPOND PREFIX="BED_MESH" MSG="Mesh loaded and active."

# ==========================
# 6️⃣ FIRST LAYER TEST
# ==========================
[gcode_macro FIRST_LAYER_TEST]
description: Print 50mm first layer square for tuning
gcode:
    G28
    AUTO_MESH
    G90
    G1 Z0.3 F300
    G1 X150 Y150 F6000
    G1 X200 Y150 E6 F600
    G1 X200 Y200 E6
    G1 X150 Y200 E6
    G1 X150 Y150 E6
    G1 Z5 F600

# ==========================
# 7️⃣ Z PROBE / Z OFFSET MACROS
# ==========================
[gcode_macro CH_CALIBRATE_Z]
description: Calibrate Z offset using magnetic probe
gcode:
    G28
    PROBE_CALIBRATE

[gcode_macro CH_SAVE_Z]
description: Accept and save Z offset
gcode:
    ACCEPT
    G4 P500
    SAVE_CONFIG

[gcode_macro CH_PROBE_TEST]
description: Test magnetic probe trigger
gcode:
    QUERY_PROBE
    G4 P500
    QUERY_PROBE

[include mainsail.cfg]
#[include bed_mesh.cfg]
[include kcm.cfg]
[include chroma_head.cfg]
#[include input_shaper.cfg]
[include cp_macro.cfg]
#[include print_extras.cfg]
#[include ecm_1.cfg]
#[include ecm_2.cfg]
#[include ecm_3.cfg]
#[include ecm_4.cfg]
#[include external_inputshaper.cfg]
#[include driver.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -1.151250, -0.770000, -0.597500, -0.583750, -0.688750, -0.912500, -0.555000, -0.565000, -0.623750
#*# 	  -1.387500, -0.938750, -0.006250, 0.172500, 0.350000, 0.260000, 0.398750, 0.236250, 0.201250
#*# 	  -0.381250, -0.087500, -0.040000, 0.221250, 0.296250, 0.181250, -0.466250, -0.611250, -0.525000
#*# 	  -1.001250, -0.216250, -0.033750, 0.211250, 0.328750, 0.300000, 0.450000, 0.266250, 0.183750
#*# 	  -0.670000, -0.301250, -0.041250, 0.072500, 0.223750, 0.201250, 0.261250, 0.045000, 0.047500
#*# 	  -0.773750, -0.396250, -0.148750, -0.035000, 0.128750, 0.120000, 0.248750, 0.142500, 0.161250
#*# 	  -0.906250, -0.453750, -0.223750, -0.118750, 0.067500, 0.083750, 0.242500, 0.155000, 0.111250
#*# 	  -0.968750, -0.582500, -0.366250, -0.176250, -0.038750, 0.036250, 0.227500, 0.146250, 0.142500
#*# 	  -1.018750, -0.450000, -0.185000, -0.115000, 0.076250, 0.120000, 0.351250, 0.303750, 0.225000
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 300.0
#*# min_y = 25.0
#*# max_y = 325.0
